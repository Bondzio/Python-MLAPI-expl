#!/usr/bin/env python
# coding: utf-8

# # **What Exactly is Cancer ?**
# 
# 
# Cancer refers to any one of a large number of diseases characterized by the development of abnormal cells that divide uncontrollably and have the ability to infiltrate and destroy normal body tissue. Cancer often has the ability to spread throughout your body.
# 
# Cancer is the second-leading cause of death in the world. But survival rates are improving for many types of cancer, thanks to improvements in cancer screening and cancer treatment.
# 
# ![](http://cancernz.org.nz/assets/Cancer-information/Bowel-cancer-booklet/Bowel-Cancer2x-Page-05-Image-0002.jpg)
# 
# 
# No Worries from Corona Now , Cancer is more Lethal 
# 
# 
# 
# **Symptoms**
# 
# Signs and symptoms caused by cancer will vary depending on what part of the body is affected.
# 
# Some general signs and symptoms associated with, but not specific to, cancer, include:
# 
# *     Fatigue
# *     Lump or area of thickening that can be felt under the skin
# *     Weight changes, including unintended loss or gain
# *     Skin changes, such as yellowing, darkening or redness of the skin, sores that won't heal, or changes to existing moles
# *     Changes in bowel or bladder habits
# *     Persistent cough or trouble breathing
# *     Difficulty swallowing
# *     Hoarseness
# *     Persistent indigestion or discomfort after eating
# *     Persistent, unexplained muscle or joint pain
# *     Persistent, unexplained fevers or night sweats
# *     Unexplained bleeding or bruising
# 
# 
# **Causes**
# 
# Cancer is caused by changes (mutations) to the DNA within cells. The DNA inside a cell is packaged into a large number of individual genes, each of which contains a set of instructions telling the cell what functions to perform, as well as how to grow and divide. Errors in the instructions can cause the cell to stop its normal function and may allow a cell to become cancerous.

# In[ ]:





from IPython.display import YouTubeVideo
YouTubeVideo("WPgJafGz4fg", height=500, width=700)


# After Knowing about Cancer In general Let's jump to our Very own Problem of Prostrate Cancer
# 
# 
# 
# ![](https://static.wixstatic.com/media/130396_1f6ada7a691f4ba8839b05c49e6a1604~mv2.jpg/v1/fill/w_626,h_290/130396_1f6ada7a691f4ba8839b05c49e6a1604~mv2.jpg) 

# 
# 
# The prostate is a small walnut shaped gland in the pelvis of men. It is located next to the bladder and can be examined by getting a digital rectal exam. Prostate cancer is a form of cancer that develops in the prostate gland. It is the second-leading cause of cancer deaths for men in the U.S. About 1 in 9 men will be diagnosed with prostate cancer in their lifetime. This year, nearly 191,000 men will be diagnosed with prostate cancer.
# 
# Growths in the prostate can be benign (not cancer) or malignant (cancer).
# 
# Benign growths (like benign prostatic hyperplasia (BPH):
# 
# *    Are rarely a threat to life
# *    Don't invade the tissues around them
# *    Don't spread to other parts of the body
# *    Can be removed and can grow back very slowly (but usually don't grow back)
#  
# **Malignant growths (prostate cancer):**
# 
# *    May sometimes be a threat to life
# *    Can spread to nearby organs and tissues (such as the bladder or rectum)
# *    Can spread (metastasize) to other parts of the body (like lymph nodes or bone) 
# *    Often can be removed but sometimes grow back
# 
# Prostate cancer cells can spread by breaking away from a prostate tumor. They can travel through blood vessels or lymph nodes to reach other parts of the body. After spreading, cancer cells may attach to other tissues and grow to form new tumors, causing damage where they land.
# 
# When prostate cancer spreads from its original place to another part of the body, the new tumor has the same kind of abnormal cells and the same name as the primary (original) tumor. For example, if prostate cancer spreads to the bones, the cancer cells in the bones are actually prostate cancer cells. The disease is metastatic prostate cancer, not bone cancer. For that reason, it's treated as prostate cancer in bone.
# 
# To understand prostate cancer, it helps to know how the prostate normally works.
# ### The Prostate
# 
# The prostate   and seminal vesicles are part of the male reproductive system. The prostate is about the size of a walnut and weighs about one ounce. The seminal vesicles are two much smaller paired glands. These glands are attached to each side of the prostate. Some have said that the seminal vesicles look like rabbit ears attached to the prostate. The prostate is below the bladder and in front of the rectum. The prostate surrounds the urethra. The urethra is a tube that carries urine from the bladder out through the penis. This is why men with an enlarged prostate have difficulty urinating. It can disrupt the flow of urine from the bladder.
# 
# The main job of the prostate and seminal vesicles is to make fluid to bathe semen. During ejaculation, sperm is made in the testicles, and then moves to the urethra. At the same time, fluid from the prostate and the seminal vesicles also moves into the urethra. This mixture of semen and fluid from the prostate and seminal vesicles forms the ejaculate that passes through the urethra and out of the penis.
# 
# When prostate cancer occurs, it starts in the prostate gland and occasionally spreads to the seminal vesicles.
# 
# ### Symptoms
# 
# In its early stages, prostate cancer often has no symptoms. When symptoms do occur, they can be like those of an enlarged prostate or BPH. Prostate cancer can also cause symptoms unrelated to BPH. If you have urinary problems, talk with your healthcare provider about them.
# 
# Symptoms of prostate cancer can be:
# 
# *    Dull pain in the lower pelvic area
# *    Frequent urinating
# *    Trouble urinating, pain, burning, or weak urine flow
# *    Blood in the urine (Hematuria) 
# *    Painful ejaculation
# *    Pain in the lower back, hips or upper thighs
# *    Loss of appetite
# *    Loss of weight
# *    Bone pain
# 
# 
# ###  Causes
# 
# No one knows why or how prostate cancer starts. Autopsy studies show 1 in 3 men over the age of 50 have some cancer cells in the prostate. Eight out of ten "autopsy cancers" found are small, with tumors that are not harmful.
# 
# Even though there is no known reason for prostate cancer, there are many risks associated with the disease.
# What Are The Risk Factors for Prostate Cancer?
# Age
# 
# As men age, their risk of getting prostate cancer goes up. It is rarely found in men younger than age 40. Damage to the genetic material (DNA) of prostate cells is more likely for men over the age of 55. Damaged or abnormal prostate cells can begin to grow out of control and form tumors.
# 
# Age is a well-known risk factor for prostate cancer. But, smoking and being overweight are more closely linked with dying from prostate cancer.
# Ethnicity
# 
# African American men have, by far, the highest incidence of the disease. One in six African American men will get prostate cancer. African American men are more likely to get prostate cancer at an earlier age. They are also more like to have aggressive tumors that grow quickly, spread and cause death. The reason why prostate cancer is more prevalent in African American men is unclear yet it may be due to socioeconomic, environmental, diet or other factors. Other ethnicities, such as Hispanic and Asian men, are less likely to get prostate cancer.
# 
# 
# #### What Are The Survival Rates For Prostate Cancer?
# 
# Many men with prostate cancer will not die from it; they will die from other causes. For men who are diagnosed, it is better if it is caught early.
# 
# Survival rates for men with prostate cancer have increased over the years, thanks to better screening and treatment options. Today, 99% of men with prostate cancer will live for at least 5 years after diagnosis. Many men having treatment are cured. Most prostate cancer is slow-growing and takes many years to progress. One out of three men will survive after five years, even if the cancer has spread to other parts of the body.
# 
# 
# ### Treatment
# 
# Some cancers grow so slowly that treatment may not be needed at all. Others grow fast and are life-threatening so treatment is usually necessary. Deciding what treatment you should get can be complex. Talk with your healthcare team about your options. Your treatment plan will depend on:
# 
# *    The stage and grade of the cancer (Gleason score and TNM stage) 
# *    Your risk category (whether the cancer is low, intermediate or high risk)
# *    Your age and health
# *    Your preferences with respect to side effects, long-term effects and treatment goals 
# 
# Results from other diagnostic tests will help your provider understand if the cancer can spread or recur (return) after treatment.
# 
# Before you decide what to do, you should consider how immediate and long-term side effects from treatment will affect your life, and what you're willing to tolerate. Also, you should consider that you may try different things over time.
# 
# If you have time before you start treatment, consider your range of options. Get a second opinion from different prostate cancer experts. You may need to see another urologist, oncologist or radiation oncologist. Consider the expertise of your doctor before you begin. With more experienced surgeons, the risk of permanent side effects (like incontinence) is lower. Also, it helps to talk with other survivors and learn from their experiences.
# 
# In addition, try and get or stay healthy. Eating a well-balanced diet, maintaining a healthy weight, exercising and not smoking are all important factors when fighting prostate cancer..
# 
# Moreover, don't ignore your emotions. Think about how you're coping with this diagnosis. Many men who have prostate cancer feel worried, stressed and angry. You and those that care about you may need to consider professional counseling.
# 
# Treatment choices for prostate cancer include:
# Surveillance
# 
# 1.    Active Surveillance
# 2.    Watchful Waiting
# 
# Localized Therapy
# 
# 1.    Surgery
# 2.    Radiation Therapy
# 3.    Cryotherapy
# 4.   Focal Therapy
# 
# Systemic Therapy 
# 
# 1.    Hormonal Therapy
# 2.    Chemotherapy
# 3.    Immunotherapy
# 
# 

# In[ ]:


from IPython.display import YouTubeVideo
YouTubeVideo("1Q7ERNtLcvk", height=500, width=700)


# In[ ]:


import pandas as pd
import numpy as np
import matplotlib.pyplot as plt; import seaborn as sns
plt.style.use('seaborn-whitegrid')
import openslide
import os
import cv2
import torch
train = pd.read_csv('../input/prostate-cancer-grade-assessment/train.csv')
gpu = torch.device("cuda:0" if torch.cuda.is_available() else "cpu")
gpu


# In[ ]:


BASE_FOLDER='/kaggle/input/prostate-cancer-grade-assessment/'


# In[ ]:


train = pd.read_csv(BASE_FOLDER+"train.csv")
test = pd.read_csv(BASE_FOLDER+"test.csv")
sub = pd.read_csv(BASE_FOLDER+"sample_submission.csv")


# 
# 
# 
# We will see the distribution of data providers:

# In[ ]:


plt.figure(figsize=(10, 7))
sns.countplot(train.data_provider)


# In[ ]:


plt.figure(figsize=(10, 7))
sns.countplot(train.isup_grade);


# In[ ]:


print('Total samples       :',train.shape[0])
for i in train.columns:
  print("Total No. of Unique values in Column {}  : {}".format(i,len(train[i].unique())))
  if len(train[i].unique()) <20:
    print(train[i].unique())


# In[ ]:


PATH = "../input/prostate-cancer-grade-assessment/"

df_train = pd.read_csv(f'{PATH}train.csv')
df_test = pd.read_csv(f'{PATH}test.csv')

df_train.head().style.set_caption('Quick Overview of train.csv')


# In[ ]:


print(f"Number of training data: {len(df_train)}\n")

print(f"Unique data_providers: {df_train.data_provider.unique()}\n")
print(f"Unique isup_grade: {df_train.isup_grade.unique()}\n")
print(f"Unique gleason_score: {df_train.gleason_score.unique()}\n")

print(f"Missing data:\n{df_train.isna().any()}\n")

masks = os.listdir(PATH + 'train_label_masks/')
images = os.listdir(PATH + 'train_images/')

df_masks = pd.Series(masks).to_frame()
df_masks.columns = ['mask_file_name']
df_masks['image_id'] = df_masks.mask_file_name.apply(lambda x: x.split('_')[0])
df_train = pd.merge(df_train, df_masks, on='image_id', how='outer')
del df_masks
print(f"There are {len(df_train[df_train.mask_file_name.isna()])} images without a mask.")


# 
# Gleason Score and ISUP Grade
# 
#  The grading process consists of finding and classifying cancer tissue into so-called Gleason patterns (3, 4, or 5)[...]. After the biopsy is assigned a Gleason score, it is converted into an ISUP grade on a 1-5 scale. [...] However, the system suffers from significant inter-observer variability between pathologists, limiting its usefulness for individual patients. This variability in ratings could lead to unnecessary treatment, or worse, missing a severe diagnosis.
# 
# 

# In[ ]:


print(f"Train data shape before reduction: {len(df_train)}")
df_train_red = df_train[~df_train.mask_file_name.isna()]
print(f"Train data shape after reduction: {len(df_train_red)}")

no_masks = df_train[df_train.mask_file_name.isna()][['image_id']]
no_masks['Suspicious_because'] = 'No Mask'


# In[ ]:


df_train_red.groupby('isup_grade').gleason_score.unique().to_frame().style.set_caption('Mapping of ISUP Grade to Gleason Score')


# 
# ### One Mislabeled Image?
# 
# In the above dataframe it looks like one image might have been converted to a wrong ISUP grade.
# 

# In[ ]:


df_train_red[(df_train_red.isup_grade == 2) & (df_train_red.gleason_score != '3+4')]


# 
# ### Differences Between Data Providers
# 
# There are two data providers.
# 
#     They used different scanners with slightly different maximum microscope resolutions and worked with different pathologists for labeling their images.
# 
# 

# In[ ]:


providers = df_train_red.data_provider.unique()

fig = plt.figure(figsize=(6,4))
ax = sns.countplot(x="isup_grade", hue="data_provider", data=df_train_red)
plt.title("ISUP Grade Count by Data Provider", fontsize=14)
plt.xlabel("ISUP Grade", fontsize=14)
plt.ylabel("Count", fontsize=14)
plt.show()


# In[ ]:




df_train_red["height"] = 0
df_train_red["width"] = 0
df_train_red[0] = 0
df_train_red[1] = 0
df_train_red[2] = 0
df_train_red[3] = 0
df_train_red[4] = 0
df_train_red[5] = 0

def get_image_data(row):
    biopsy = skimage.io.MultiImage(PATH + 'train_label_masks/' + row.image_id + '_mask.tiff')
    temp = biopsy[-1][:, :, 0]
    counts = pd.Series(temp.reshape(-1)).value_counts()
    row.height = temp.shape[0]
    row.width = temp.shape[1]
    row.update(counts)
    return row





# In[ ]:


import skimage.io

df_train_red = df_train_red.apply(lambda row: get_image_data(row), axis=1)
df_train_red['pixels'] = df_train_red.height * df_train_red.width


# In[ ]:


fig, [ax1, ax2] = plt.subplots(nrows=1, ncols=2, figsize=(16, 6))

"""
Inspired by something similiar I saw here https://www.kaggle.com/dhananjay3/panda-eda-all-you-need-to-know
"""
sns.scatterplot(data=df_train_red, x='width', y='height', marker='.',hue='data_provider', ax=ax1)
ax1.set_title("Image Sizes by Data Provider", fontsize=14)
ax1.set_xlabel("Image Width", fontsize=14)
ax1.set_ylabel("Image Height", fontsize=14)

sns.kdeplot(df_train_red[df_train_red.data_provider == 'karolinska'].pixels, label='karolinska', ax=ax2)
sns.kdeplot(df_train_red[df_train_red.data_provider == 'radboud'].pixels, label= 'radboud', ax=ax2)

ax2.set_title("Image Sizes by Data Provider", fontsize=14)
ax2.set_ylabel("Pixels per Image", fontsize=14)
plt.show()


# This kernel would be updated soon , just performed the preliminary EDA
# 
# Detailed EDA and model architechture to be explained in no time 
